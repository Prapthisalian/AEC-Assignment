<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mindful Journey</title>
    <link rel="stylesheet" href="style.css?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="landing-container">
        <nav class="navbar">
            <div class="logo"><a href="dashboard.html" style="text-decoration:none; color:inherit;">Mindful Journey</a></div>
            <div class="nav-links">
                <a href="mood_history.html" class="btn btn-secondary">History</a>
                <a href="mood_analytics.html" class="btn btn-secondary">Analytics</a>
                <a href="profile.html" class="btn btn-secondary">Profile</a>
                <button onclick="clearSession()" class="btn btn-primary" style="background: #ff9a9e; border:none;">Logout</button>
            </div>
        </nav>
        
        <div class="dashboard-container">
            <h2 id="welcome-msg">Welcome!</h2>
            <p id="date-display" style="margin-bottom: 2rem;"></p>
            
            <div class="diary-input-area">
                <h3>How are you feeling today?</h3>
                <textarea id="diary-text" placeholder="Write your thoughts here... or use voice input."></textarea>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button id="voice-btn" class="btn btn-secondary">üé§ Voice Input</button>
                    <button id="save-btn" class="btn btn-cta">Save Entry</button>
                    <span id="listening-indicator" style="display: none; color: red;">Listening...</span>
                </div>
            </div>
            
            <div id="ai-reflection" class="feature-card" style="width: 100%; margin-top: 2rem; display: none; text-align: left;">
                <h3 style="margin-top: 0;">AI Reflection</h3>
                <p id="ai-text" style="font-style: italic;"></p>
            </div>
        </div>
    </div>
    <script src="app.js?v=2"></script>
    <script>
        requireAuth();
        
        // Setup Date
        const today = new Date();
        document.getElementById('date-display').textContent = today.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Voice Input Logic - Continuous Mode with Manual Stop
        const voiceBtn = document.getElementById('voice-btn');
        const textArea = document.getElementById('diary-text');
        const indicator = document.getElementById('listening-indicator');
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            let isListening = false;
            let finalTranscript = '';
            
            voiceBtn.onclick = () => {
                if (isListening) {
                    // Stop listening
                    console.log('üõë Stopping recognition');
                    if (recognition) {
                        recognition.stop();
                    }
                    isListening = false;
                    voiceBtn.textContent = "üé§ Voice Input";
                    voiceBtn.classList.remove('listening');
                    indicator.style.display = 'none';
                    return;
                }
                
                // Start listening
                console.log('üé§ Starting recognition');
                isListening = true;
                finalTranscript = '';
                
                // Create new recognition instance
                if (recognition) {
                    try { recognition.abort(); } catch(e) {}
                }
                
                recognition = new SpeechRecognition();
                recognition.continuous = true;  // Keep listening
                recognition.interimResults = true;  // Show interim results
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = () => {
                    console.log('‚úì Recognition started');
                    voiceBtn.textContent = "üî¥ Listening (Click to Stop)";
                    voiceBtn.classList.add('listening');
                    indicator.style.display = 'inline';
                    indicator.textContent = 'üé§ Listening... Speak now!';
                };
                
                recognition.onend = () => {
                    console.log('‚úì Recognition ended');
                    isListening = false;
                    voiceBtn.textContent = "üé§ Voice Input";
                    voiceBtn.classList.remove('listening');
                    
                    // Apply final transcript
                    if (finalTranscript.trim()) {
                        if (textArea.value.trim()) {
                            textArea.value += ' ' + finalTranscript.trim();
                        } else {
                            textArea.value = finalTranscript.trim();
                        }
                        indicator.textContent = '‚úì Done! Your text is ready.';
                        setTimeout(() => indicator.style.display = 'none', 3000);
                    } else {
                        indicator.style.display = 'none';
                    }
                };
                
                recognition.onresult = (event) => {
                    console.log('üìù Got results');
                    let interimTranscript = '';
                    
                    // Process all results
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                            console.log('‚úì Final:', transcript);
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Show what we're hearing
                    if (interimTranscript) {
                        indicator.textContent = 'üé§ Hearing: "' + interimTranscript + '"';
                        console.log('üëÇ Interim:', interimTranscript);
                    } else if (finalTranscript) {
                        indicator.textContent = '‚úì Got: "' + finalTranscript.trim() + '" (keep talking or click stop)';
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('‚ùå Error:', event.error);
                    
                    if (event.error === 'no-speech') {
                        // Don't stop, just inform
                        indicator.textContent = '‚è∏Ô∏è Waiting for speech... (speak louder or click to stop)';
                        // Don't set isListening = false, let it keep trying
                        return;
                    } else if (event.error === 'audio-capture') {
                        alert('No microphone detected.');
                        isListening = false;
                    } else if (event.error === 'not-allowed') {
                        alert('Microphone permission denied. Please:\n1. Click the üîí icon in address bar\n2. Allow microphone\n3. Refresh page');
                        isListening = false;
                    } else if (event.error === 'aborted') {
                        console.log('Recognition aborted');
                        isListening = false;
                    } else {
                        indicator.textContent = '‚ö†Ô∏è Error: ' + event.error;
                        setTimeout(() => indicator.style.display = 'none', 3000);
                        isListening = false;
                    }
                    
                    if (!isListening) {
                        voiceBtn.textContent = "üé§ Voice Input";
                        voiceBtn.classList.remove('listening');
                    }
                };
                
                // Start it!
                try {
                    recognition.start();
                } catch (e) {
                    console.error('‚ùå Start failed:', e);
                    alert('Could not start voice recognition. Please refresh the page.');
                    isListening = false;
                }
            };
        } else {
            voiceBtn.style.display = 'none';
            console.warn('Speech recognition not supported');
        }
        
        // Save Entry
        document.getElementById('save-btn').onclick = async () => {
            const text = textArea.value;
            if (!text.trim()) return alert("Please write something!");
            
            const btn = document.getElementById('save-btn');
            btn.textContent = "Analyzing...";
            btn.disabled = true;
            
            const result = await addEntry(today.toISOString().split('T')[0], text);
            
            btn.textContent = "Save Entry";
            btn.disabled = false;
            
            if (result.success) {
                document.getElementById('ai-text').textContent = result.analysis;
                document.getElementById('ai-reflection').style.display = 'block';
                textArea.value = ''; // Clear input if desired, or keep it.
            } else {
                alert('Error: ' + result.error);
            }
        };
    </script>
</body>
</html>
